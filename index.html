<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رابط کاربری چت</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.rtl.min.css" integrity="sha384-gXt9imSW0VcJVHezoNQsP+TNrjYXoGcrqBZJpry9zJt8PCQjobwmhMGaDHTASo9N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css">
    <style>
        body {
            font-family: 'Vazir', sans-serif;
        }
        .message-bubble {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            width: fit-content;
        }
        .user-message {
            background-color: #d1ecf1;
            align-self: flex-start;
        }
        .assistant-message {
            background-color: #f8d7da;
            align-self: flex-end;
        }
        .loading-message {
            background-color: #f1f1f1;
            align-self: flex-end;
            font-style: italic;
            color: #888;
        }
        .message-area {
            max-height: 70vh;
            overflow-y: auto;
        }
        .source-item img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            margin-left: 10px;
        }
        .source-item {
            width: 100%;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .source-item .source-text {
            flex-grow: 1;
            overflow: hidden;
        }
        .source-item .source-text strong {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .source-item .source-text span {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .source-item .source-description {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .sources {
            overflow-y: auto;
            max-height: 70vh;
        }
    </style>
</head>
<body>
    <div class="container-fluid h-100 d-flex flex-column">
        <div class="header py-2 border-bottom text-center">
            <h1>سرصفحه سایت</h1>
        </div>
        <div class="content flex-grow-1 d-flex">
            <div class="sources flex-shrink-0 border-left p-3" style="width: 30%;">
                <div id="source-list">
                    <!-- Sources will be dynamically inserted here -->
                </div>
            </div>
            <div class="chat d-flex flex-column flex-grow-1 p-3">
                <div id="message-area" class="message-area flex-grow-1 border p-3 overflow-auto d-flex flex-column">
                    <!-- Messages will be dynamically inserted here -->
                </div>
                <div class="input-area d-flex pt-3 border-top">
                    <input type="text" id="input-message" class="form-control me-2" placeholder="پیام ورودی">
                    <button id="send-button" class="btn btn-primary">ارسال</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        document.getElementById('send-button').addEventListener('click', function() {
            const inputMessage = document.getElementById('input-message').value;
            if (inputMessage.trim() === '') {
                return;
            }

            // Add the user message to the chat
            const messageArea = document.getElementById('message-area');
            const userMessageBubble = document.createElement('div');
            userMessageBubble.classList.add('message-bubble', 'user-message');
            userMessageBubble.textContent = inputMessage;
            messageArea.appendChild(userMessageBubble);

            // Show loading message
            const loadingMessageBubble = document.createElement('div');
            loadingMessageBubble.classList.add('message-bubble', 'loading-message');
            loadingMessageBubble.textContent = 'در حال تولید پاسخ...';
            messageArea.appendChild(loadingMessageBubble);

            // Scroll to the bottom of the message area
            messageArea.scrollTop = messageArea.scrollHeight;

            // Clear the input field
            document.getElementById('input-message').value = '';

            // Send the message to the API
            fetch('http://localhost:8080/api/message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: inputMessage })
            })
            .then(response => response.json())
            .then(async data => {
                // Remove loading message
                messageArea.removeChild(loadingMessageBubble);

                // Add the assistant message to the chat
                const assistantMessageBubble = document.createElement('div');
                assistantMessageBubble.classList.add('message-bubble', 'assistant-message');
                assistantMessageBubble.innerHTML = marked.parse(data.response); // Render Markdown to HTML
                messageArea.appendChild(assistantMessageBubble);

                // Update the sources list
                const sourceList = document.getElementById('source-list');
                
                // Fetch metadata for each source URL
                for (const source of data.sources) {
                    const { url, content } = source;

                    // Add placeholder for source item
                    const sourceItemPlaceholder = document.createElement('div');
                    sourceItemPlaceholder.classList.add('source-item', 'mb-3', 'd-flex', 'align-items-center');
                    sourceItemPlaceholder.innerHTML = `<div class="source-text"><strong>Loading...</strong><span>${url}</span><br><span>Extracted Data: ${content}</span></div>`;
                    sourceList.appendChild(sourceItemPlaceholder);

                    try {
                        const metadata = await fetchMetadata(url);
                        const sourceItem = document.createElement('div');
                        sourceItem.classList.add('source-item', 'mb-3', 'd-flex', 'align-items-center');

                        const sourceImage = document.createElement('img');
                        sourceImage.src = metadata.image;
                        sourceImage.classList.add('img-fluid', 'me-2');
                        sourceImage.alt = 'تصویر منبع';

                        const sourceText = document.createElement('div');
                        sourceText.classList.add('source-text', 'flex-grow-1');
                        sourceText.innerHTML = `<strong>${metadata.title}</strong><br><span class="source-description">${metadata.description}</span><br><span>Extracted Data: ${content}</span>`;

                        const sourceLink = document.createElement('a');
                        sourceLink.href = url;
                        sourceLink.textContent = 'Read more';
                        sourceLink.classList.add('ms-2');

                        sourceItem.appendChild(sourceImage);
                        sourceItem.appendChild(sourceText);
                        sourceItem.appendChild(sourceLink);
                        sourceList.replaceChild(sourceItem, sourceItemPlaceholder); // Replace placeholder with actual source item
                    } catch (error) {
                        console.error('Error fetching metadata:', error);
                        // Update placeholder with error message
                        sourceItemPlaceholder.querySelector('.source-text').innerHTML = `<strong>Error loading metadata</strong><span>${url}</span><br><span>Extracted Data: ${content}</span>`;
                    }
                }

                // Scroll to the bottom of the message area
                messageArea.scrollTop = messageArea.scrollHeight;
            })
            .catch(error => {
                // Remove loading message on error
                messageArea.removeChild(loadingMessageBubble);
                console.error('Error:', error);
            });
        });

        async function fetchMetadata(url) {
            const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
            const data = await response.json();
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, 'text/html');

            const title = doc.querySelector('meta[property="og:title"]')?.content || doc.title;
            const description = doc.querySelector('meta[property="og:description"]')?.content || '';
            const image = doc.querySelector('meta[property="og:image"]')?.content || '';

            return { title, description, image };
        }
    </script>
</body>
</html>
